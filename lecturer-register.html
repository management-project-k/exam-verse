<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <title>Exam Verse – Lecturer Register</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary-blue: #1a73e8; --error-red: #dc3545; --success-green: #28a745;
      --light-bg: #ffffff; --dark-bg: #181818; --dark-gray: #2a2a2a;
      --transition: all 0.3s ease;
    }
    body { font-family: 'Poppins', sans-serif; background: var(--light-bg); color: #333; min-height: 100vh; }
    body.dark { background: var(--dark-bg); color: #fff; }
    .register-page { min-height: 100vh; display: flex; flex-direction: column; position: relative; }
    
    /* PERFECT TOGGLE SPACING & VISIBILITY */
    .theme-toggle {
      position: absolute;
      top: 20px; right: 20px;
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      cursor: pointer;
      width: 52px; height: 52px;
      display: flex; align-items: center; justify-content: center;
      border-radius: 50%;
      transition: var(--transition);
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .theme-toggle:hover {
      background: rgba(26,115,232,0.2);
      transform: scale(1.05);
    }
    body.dark .theme-toggle {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.3);
    }
    .theme-icon {
      width: 28px; height: 28px;
      position: absolute;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      color: var(--primary-blue);
    }
    .sun-icon { opacity: 1; transform: rotate(0deg); }
    body.dark .sun-icon { opacity: 0; transform: rotate(180deg); }
    .moon-icon { opacity: 0; transform: rotate(-180deg); }
    body.dark .moon-icon { opacity: 1; transform: rotate(0deg); }

    .register-main { flex: 1; display: flex; align-items: center; justify-content: center; padding: 60px 20px 40px; }
    .register-card { width: 100%; max-width: 480px; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.1); background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); animation: slideUp 0.6s ease-out; }
    body.dark .register-card { box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    @keyframes slideUp { from { opacity: 0; transform: translateY(50px); } to { opacity: 1; transform: translateY(0); } }
    .register-card h2 { text-align: center; color: var(--primary-blue); font-size: 28px; font-weight: 600; margin-bottom: 8px; }
    .version-capsule { display: block; width: fit-content; margin: 0 auto 24px; padding: 6px 16px; background: rgba(26,115,232,0.1); color: var(--primary-blue); font-size: 11px; font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; border-radius: 50px; }
    .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
    .form-group label { font-weight: 500; font-size: 14px; }
    .form-group input, .form-group select { padding: 14px 16px; border: 2px solid rgba(0,0,0,0.1); border-radius: 8px; font-family: 'Poppins', sans-serif; font-size: 16px; transition: var(--transition); }
    body.dark .form-group input, body.dark .form-group select { background: var(--dark-gray); color: #fff; border-color: rgba(255,255,255,0.1); }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 3px rgba(26,115,232,0.1); }
    .register-btn { width: 100%; padding: 16px; background: var(--primary-blue); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; transition: var(--transition); margin-top: 8px; }
    .register-btn:hover:not(:disabled) { background: #1557b0; transform: translateY(-2px); }
    .register-btn:disabled { background: #ccc; cursor: not-allowed; }
    .footer { text-align: center; padding: 24px 0; margin-top: auto; border-top: 1px solid rgba(0,0,0,0.1); }
    body.dark .footer { border-top-color: rgba(255,255,255,0.1); }
    .footer a { color: var(--primary-blue); text-decoration: none; font-weight: 500; }
    .selected-items { min-height: 48px; padding: 8px 12px; border: 2px solid rgba(0,0,0,0.1); border-radius: 8px; background: var(--light-bg); display: flex; flex-wrap: wrap; gap: 8px; align-items: center; font-size: 14px; }
    body.dark .selected-items { background: var(--dark-gray); border-color: rgba(255,255,255,0.1); color: #fff; }
    .selected-items .placeholder { color: #999; font-style: italic; }
    body.dark .selected-items .placeholder { color: #aaa; }
    .selected-items .tag { background: var(--primary-blue); color: white; padding: 4px 10px; border-radius: 50px; font-size: 13px; display: flex; align-items: center; gap: 6px; }
    .selected-items .tag .remove { cursor: pointer; font-weight: bold; }
    .open-modal-btn { margin-top: 8px; background: transparent; border: 1px solid var(--primary-blue); color: var(--primary-blue); padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer; transition: var(--transition); }
    .open-modal-btn:hover { background: rgba(26,115,232,0.1); }
    body.dark .open-modal-btn { color: var(--primary-blue); border-color: var(--primary-blue); }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); animation: fadeIn 0.3s ease; }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--light-bg); padding: 32px; border-radius: 16px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center; animation: slideUpModal 0.4s ease-out; max-height: 80vh; overflow-y: auto; }
    body.dark .modal { background: var(--dark-gray); color: #fff; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUpModal { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    .modal h3 { color: var(--primary-blue); font-size: 22px; margin-bottom: 16px; }
    .search-box { margin-bottom: 16px; }
    .search-box input { width: 100%; padding: 10px; border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; font-size: 14px; background: var(--light-bg); }
    body.dark .search-box input { background: var(--dark-gray); border-color: rgba(255,255,255,0.1); color: #fff; }
    .subject-list { max-height: 300px; overflow-y: auto; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; padding: 8px; background: var(--light-bg); }
    body.dark .subject-list { border-color: rgba(255,255,255,0.1); background: var(--dark-gray); }
    .subject-item { padding: 10px; cursor: pointer; border-radius: 6px; display: flex; align-items: center; gap: 10px; transition: var(--transition); }
    .subject-item:hover { background: rgba(26,115,232,0.1); }
    body.dark .subject-item:hover { background: rgba(26,115,232,0.2); }
    .subject-item input[type="checkbox"] { transform: scale(1.2); }
    .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
    .modal-actions .btn-close { width: auto; padding: 8px 16px; background: var(--primary-blue); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
    .modal-actions .btn-close:hover { background: #1557b0; transform: translateY(-1px); }
    .modal-actions .btn-cancel { background: #6c757d; }
    .modal-actions .btn-cancel:hover { background: #5a6268; }
    .info-row { background: rgba(0,0,0,0.05); border-radius: 8px; padding: 12px; margin: 16px 0; text-align: left; }
    body.dark .info-row { background: rgba(255,255,255,0.1); }
  </style>
</head>
<body>
  <div class="register-page">
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle Theme">
      <svg class="theme-icon sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
      <svg class="theme-icon moon-icon" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
    </button>
   
    <main class="register-main">
      <div class="register-card">
        <h2>Register Into Exam Verse As Lecturer</h2>
        <span class="version-capsule">Version 1.0</span>
       
        <form id="registerForm">
          <div class="form-group">
            <label for="name">Full Name *</label>
            <input type="text" id="name" required autocomplete="off" />
          </div>
          <div class="form-group">
            <label for="email">Official Email *</label>
            <input type="email" id="email" required autocomplete="off" />
          </div>
          <div class="form-group">
            <label for="phone">Phone (Optional)</label>
            <input type="tel" id="phone" autocomplete="off" />
          </div>
          <div class="form-group">
            <label>Teaching Subjects * (Select at least 2)</label>
            <div id="selectedSubjects" class="selected-items">
              <span class="placeholder">Click to select subjects</span>
            </div>
            <button type="button" class="open-modal-btn" onclick="openSubjectModal()">Select Subjects</button>
            <input type="hidden" id="subjects" required />
          </div>
          <input type="hidden" id="role" value="Lecturer" />
          <div class="form-group">
            <label for="password">Password *</label>
            <input type="password" id="password" required autocomplete="new-password" />
          </div>
          <div class="form-group">
            <label for="confirmPassword">Confirm Password *</label>
            <input type="password" id="confirmPassword" required autocomplete="new-password" />
          </div>
          <button type="submit" class="register-btn" id="registerBtn">Register</button>
        </form>
      </div>
    </main>
   
    <footer class="footer">
      <p>Designed & Developed by <a href="https://www.project-k.co.in" target="_blank">Project K</a></p>
    </footer>
  </div>

  <!-- SUBJECT MODAL -->
  <div class="modal-overlay" id="subjectModal" onclick="closeSubjectModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <h3>Select Teaching Subjects</h3>
      <div class="search-box">
        <input type="text" id="subjectSearch" placeholder="Search subjects..." onkeyup="filterSubjects()" />
      </div>
      <div class="subject-list" id="subjectList"></div>
      <div class="modal-actions">
        <button class="btn-close btn-cancel" onclick="closeSubjectModal()">Cancel</button>
        <button class="btn-close" onclick="confirmSubjects()">Done</button>
      </div>
    </div>
  </div>

  <!-- SUCCESS MODAL -->
  <div class="modal-overlay" id="successModal" onclick="closeModal('successModal')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3>Registration Successful!</h3>
        <p id="successMessage"></p>
        <small>MFA will be enabled post-approval.</small>
      </div>
      <button class="btn-close" onclick="closeModal('successModal')">Close</button>
    </div>
  </div>

  <!-- ERROR MODAL -->
  <div class="modal-overlay" id="errorModal" onclick="closeModal('errorModal')">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <h3 style="color: var(--error-red);">Registration Failed</h3>
      </div>
      <div class="info-row" id="errorInfo" style="background: rgba(220,53,69,0.1); text-align: left;"></div>
      <button class="btn-close" onclick="closeModal('errorModal')">Close</button>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxzM47Sl_UoL6YiDefx34IqEd55XttMH1tvMAehQ1Iey0xfGxpRBYHWkqLDIniEUqvk/exec';
    let isDark = localStorage.getItem('theme') === 'dark';
    if (isDark) document.body.classList.add('dark');
    let selectedSubjectList = [];
    let SUBJECTS = [];

    function toggleTheme() {
      isDark = !isDark;
      document.body.classList.toggle('dark', isDark);
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    function closeModal(id) {
      document.getElementById(id).classList.remove('show');
    }

    function showSuccess(name, email, lecturerId) {
      let msg = `Name<br><span style="font-weight:600;">${name}</span><br>
                 Email<br><span style="font-weight:600;">${email}</span><br>
                 Lecturer ID<br><span style="font-weight:600;">${lecturerId}</span><br>
                 Subjects<br><span style="font-weight:600;">${selectedSubjectList.join(', ')}</span><br><br>
                 Site is under maintenance.<br>Team will reach out for approval.`;
      document.getElementById('successMessage').innerHTML = msg;
      document.getElementById('successModal').classList.add('show');
    }

    function showError(message) {
      document.getElementById('errorInfo').innerHTML = message;
      document.getElementById('errorModal').classList.add('show');
    }

    // SUBJECT MODAL LOGIC
    async function fetchSubjects() {
      try {
        const res = await fetch(SCRIPT_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'getSubjects' })
        });
        const data = await res.json();
        if (data.success) {
          SUBJECTS = data.subjects;
        }
      } catch (e) { 
        console.error('Failed to fetch subjects:', e);
        SUBJECTS = ['C Programming', 'Data Structures', 'DBMS', 'OS', 'Computer Networks']; // Fallback
      }
    }

    function openSubjectModal() {
      if (SUBJECTS.length === 0) fetchSubjects();
      document.getElementById('subjectModal').classList.add('show');
      renderSubjectList();
    }

    function closeSubjectModal() {
      document.getElementById('subjectModal').classList.remove('show');
      document.getElementById('subjectSearch').value = '';
    }

    function renderSubjectList() {
      const container = document.getElementById('subjectList');
      const search = document.getElementById('subjectSearch').value.toLowerCase();
      container.innerHTML = '';
      SUBJECTS
        .filter(s => s.toLowerCase().includes(search))
        .forEach(sub => {
          const checked = selectedSubjectList.includes(sub) ? 'checked' : '';
          container.innerHTML += `
            <label class="subject-item">
              <input type="checkbox" value="${sub}" ${checked} onchange="toggleSubject(this)">
              <span>${sub}</span>
            </label>`;
        });
    }

    function toggleSubject(cb) {
      const val = cb.value;
      if (cb.checked) {
        if (!selectedSubjectList.includes(val)) selectedSubjectList.push(val);
      } else {
        selectedSubjectList = selectedSubjectList.filter(s => s !== val);
      }
      updateSelectedDisplay();
    }

    function updateSelectedDisplay() {
      const box = document.getElementById('selectedSubjects');
      box.innerHTML = '';
      if (selectedSubjectList.length === 0) {
        box.innerHTML = '<span class="placeholder">Click to select subjects</span>';
      } else {
        selectedSubjectList.forEach(s => {
          box.innerHTML += `
            <div class="tag">
              ${s}
              <span class="remove" onclick="removeSubject('${s.replace(/'/g, "\\'")}')">×</span>
            </div>`;
        });
      }
      document.getElementById('subjects').value = selectedSubjectList.join(',');
    }

    window.removeSubject = function (s) {
      selectedSubjectList = selectedSubjectList.filter(x => x !== s);
      updateSelectedDisplay();
      renderSubjectList();
    };

    window.filterSubjects = function () { 
      renderSubjectList(); 
    };

    window.confirmSubjects = function () {
      if (selectedSubjectList.length < 2) {
        alert('Please select at least 2 subjects for lecturer role.');
        return;
      }
      closeSubjectModal();
      updateSelectedDisplay();
    };

    // FORM SUBMISSION
    document.getElementById('registerForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const data = {
        name: document.getElementById('name').value.trim(),
        email: document.getElementById('email').value.trim(),
        phone: document.getElementById('phone').value.trim(),
        subjects: document.getElementById('subjects').value.trim(),
        role: document.getElementById('role').value,
        password: document.getElementById('password').value,
        confirmPassword: document.getElementById('confirmPassword').value,
        userAgent: navigator.userAgent
      };

      let errors = [];
      if (!data.name) errors.push("• Full Name is required.");
      if (!data.email || !/^[^\s@]+@(?:svr|govpoly)\.(?:edu|ac)\.in$/.test(data.email)) errors.push("• Valid official email (e.g., @svr.ac.in or @govpoly.ac.in) is required.");
      if (!data.subjects || selectedSubjectList.length < 2) errors.push("• At least 2 subjects must be selected.");
      if (data.password.length < 6) errors.push("• Password must be at least 6 characters.");
      if (data.password !== data.confirmPassword) errors.push("• Passwords do not match.");

      if (errors.length > 0) {
        showError(errors.join('<br>'));
        return;
      }

      const btn = document.getElementById('registerBtn');
      btn.disabled = true; btn.textContent = 'Registering...';

      try {
        const res = await fetch(SCRIPT_URL, { 
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'lecturerRegister', ...data }) 
        });
        const result = await res.json();
        if (result.success) {
          showSuccess(data.name, data.email, result.lecturerId);
          document.getElementById('registerForm').reset();
          selectedSubjectList = [];
          updateSelectedDisplay();
        } else {
          showError(`• ${result.message}`);
        }
      } catch (err) {
        showError('• Network error. Try again.');
      } finally {
        btn.disabled = false; btn.textContent = 'Register';
      }
    });
  </script>
</body>
</html>
